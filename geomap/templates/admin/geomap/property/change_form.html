{% extends "admin/change_form.html" %}
{% load leaflet_tags %}

{% block extrastyle %}{{ block.super }}
  {% leaflet_css %}
  {% leaflet_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <style>
      #main {
        position: relative;
        vertical-align: top;
    }
      .selected_pin {
          width: 30px;
          height: 30px;
          border-radius: 50% 50% 50% 0;
          background: #FF2D00;
          position: absolute;
          transform: rotate(-45deg);
          left: 50%;
          top: 50%;
          margin: -20px 0 0 -20px;
      }
      .selected_pin:after {
          content: "";
          width: 14px;
          height: 14px;
          margin: 8px 0 0 8px;
          background: #e6e6e6;
          position: absolute;
          border-radius: 50%;
      }
      .pin {
          width: 30px;
          height: 30px;
          border-radius: 50% 50% 50% 0;
          background: #00cae9;
          position: absolute;
          transform: rotate(-45deg);
          left: 50%;
          top: 50%;
          margin: -20px 0 0 -20px;
      }
      .pin:after {
          content: "";
          width: 14px;
          height: 14px;
          margin: 8px 0 0 8px;
          background: #e6e6e6;
          position: absolute;
          border-radius: 50%;
      }
   </style>

{% endblock %}

{% block object-tools-items %}{{ block.super }}
    {% if original.netbox_id %}
    <li>
        {{ original.netbox_url|safe }}
    </li>
    {% endif %}
    <li>
        <a href="{% url 'admin:done_change' original.pk %}" class="grp-state-focus">
            {% if not original.done %}
                COMPLETED
            {% else %}
                UNCOMPLETED
            {% endif %}
        </a>
    </li>
{% endblock %}

{% block field_sets %}
{% for fieldset in adminform %}
  {% include "admin/geomap/property/fieldset.html" %}
{% endfor %}
{% endblock %}

{% block content %}{{ block.super }}
<script type="text/javascript">
        var changeHandler = function() {
            var model = $("#id_equipment").val();
            $.ajax({
                url: "http://10.0.0.225:8000/api/dcim/device-types/?model=" + model,
                type: 'GET',
                crossDomain : true,
                success: function(data) {
                    var tags = data['results'][0]["tags"];
                    if (tags.includes('router')) {
                        $('.field-card,.field-rsp').removeClass('hidden');
                    } else {
                        $('.field-card,.field-rsp').addClass('hidden');
                    }

                }
            });
        };
        changeHandler();
        $("#id_equipment").change(changeHandler);

        $(window).on("resize", function () {
                $("#main").height($(window).height()*0.4);
                map.invalidateSize();
            }).trigger("resize");


        function main_map_init (map, options) {

            var popup = L.popup()

            const selected_icon = L.divIcon({
              iconAnchor: [2, 25],
              labelAnchor: [-6, 0],
              popupAnchor: [0, -40],
              html: `<div class="selected_pin" />`
            })
            const icon = L.divIcon({
              iconAnchor: [2, 25],
              labelAnchor: [-6, 0],
              popupAnchor: [0, -40],
              html: `<div class="pin" />`
            })

            var lon = "{{ property.location.x }}";
            var lat = "{{ property.location.y }}";
            window.map = map.setView([lat, lon], 17);
            var marker = L.marker([lat, lon], {icon: selected_icon});
            window.map.addLayer(marker);
            marker.bindPopup(popup.setContent(`{{ property.popup_desc|safe }}`)).openPopup()

            var polyline = L.polyline({{ gpon_feeds|safe }}, {color: 'green'}).addTo(map);
            L.polylineDecorator(polyline, {
            patterns: [
                {offset: '50%', repeat: 0, symbol: L.Symbol.arrowHead({pixelSize: 25, polygon: false, pathOptions: {color: 'green', stroke: true}})}
            ]}).addTo(map);

            {% for feed in property.feeds.all %}
                L.polyline([[[lat, lon], [{{ feed.location.y }}, {{ feed.location.x }}]]]).addTo(map).bindPopup(`{{ property.link|safe }} <-> {{ feed.link|safe }}`);
            {% endfor %}

            {% for property in properties %}
              var lon = "{{ property.location.x }}";
              var lat = "{{ property.location.y }}";
              L.marker([lat, lon], {icon: icon}).addTo(map).bindPopup(`{{ property.popup_desc|safe }}`);

              {% for feed in property.feeds.all %}
                L.polyline([[[lat, lon], [{{ feed.location.y }}, {{ feed.location.x }}]]]).addTo(map).bindPopup(`{{ property.link|safe }} <-> {{ feed.link|safe }}`);
              {% endfor %}
            {% endfor %}


        }
</script>
{% endblock %}
